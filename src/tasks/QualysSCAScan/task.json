{
  "$schema": "https://raw.githubusercontent.com/Microsoft/azure-pipelines-task-lib/master/tasks.schema.json",
  "id": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
  "name": "QualysSCAScan",
  "friendlyName": "Qualys SCA Dependency Scan",
  "description": "Scan code dependencies for vulnerabilities using Qualys QScanner CLI",
  "helpMarkDown": "[Learn more](https://docs.qualys.com/en/cs/latest/)",
  "category": "Utility",
  "visibility": ["Build", "Release"],
  "runsOn": ["Agent", "DeploymentGroup"],
  "author": "Andrew Nelson (anelson@qualys.com)",
  "version": {
    "Major": 2,
    "Minor": 2,
    "Patch": 0
  },
  "instanceNameFormat": "Qualys SCA Scan: $(scanPath)",
  "groups": [
    {
      "name": "connection",
      "displayName": "Qualys Connection",
      "isExpanded": true
    },
    {
      "name": "scan",
      "displayName": "Scan Configuration",
      "isExpanded": true
    },
    {
      "name": "policy",
      "displayName": "Policy & Thresholds",
      "isExpanded": false
    },
    {
      "name": "sbom",
      "displayName": "SBOM Generation",
      "isExpanded": false
    },
    {
      "name": "advanced",
      "displayName": "Advanced Options",
      "isExpanded": false
    }
  ],
  "inputs": [
    {
      "name": "qualysConnection",
      "type": "connectedService:QualysApiConnection",
      "label": "Qualys Service Connection",
      "required": true,
      "helpMarkDown": "Select the Qualys API service connection",
      "groupName": "connection"
    },
    {
      "name": "scanPath",
      "type": "filePath",
      "label": "Scan Path",
      "required": true,
      "defaultValue": "$(Build.SourcesDirectory)",
      "helpMarkDown": "Path to directory containing source code or manifest files",
      "groupName": "scan"
    },
    {
      "name": "scanSecrets",
      "type": "boolean",
      "label": "Scan for Secrets",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "Enable secrets detection to find exposed credentials, API keys, and tokens in your code",
      "groupName": "scan"
    },
    {
      "name": "excludeDirs",
      "type": "multiLine",
      "label": "Exclude Directories",
      "required": false,
      "helpMarkDown": "Comma-separated list of directories to exclude (e.g., node_modules,vendor,test)",
      "groupName": "scan"
    },
    {
      "name": "excludeFiles",
      "type": "multiLine",
      "label": "Exclude Files",
      "required": false,
      "helpMarkDown": "Comma-separated list of file patterns to exclude",
      "groupName": "scan"
    },
    {
      "name": "offlineScan",
      "type": "boolean",
      "label": "Offline Scan",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "Perform offline scan without uploading results to Qualys platform",
      "groupName": "scan"
    },
    {
      "name": "usePolicyEvaluation",
      "type": "boolean",
      "label": "Use Qualys Policy Evaluation",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "Use centralized Qualys policy for pass/fail determination. Requires policy configuration in Qualys. If disabled, local thresholds are used.",
      "groupName": "policy"
    },
    {
      "name": "policyTags",
      "type": "string",
      "label": "Policy Tags",
      "required": false,
      "defaultValue": "",
      "helpMarkDown": "Comma-separated policy tags to evaluate (e.g., production,ci-cd)",
      "groupName": "policy",
      "visibleRule": "usePolicyEvaluation = true"
    },
    {
      "name": "failOnSeverity",
      "type": "pickList",
      "label": "Fail on Severity",
      "required": false,
      "defaultValue": "4",
      "options": {
        "5": "Critical (5)",
        "4": "High (4) and above",
        "3": "Medium (3) and above",
        "2": "Low (2) and above",
        "1": "Informational (1) and above",
        "0": "Do not fail on severity"
      },
      "helpMarkDown": "Fail the build if vulnerabilities at or above this severity are found (local threshold, used when policy evaluation is disabled)",
      "groupName": "policy",
      "visibleRule": "usePolicyEvaluation = false"
    },
    {
      "name": "generateSbom",
      "type": "boolean",
      "label": "Generate SBOM",
      "required": false,
      "defaultValue": "true",
      "helpMarkDown": "Generate Software Bill of Materials",
      "groupName": "sbom"
    },
    {
      "name": "sbomFormat",
      "type": "pickList",
      "label": "SBOM Format",
      "required": false,
      "defaultValue": "spdx",
      "options": {
        "spdx": "SPDX",
        "cyclonedx": "CycloneDX",
        "spdx,cyclonedx": "Both SPDX and CycloneDX"
      },
      "visibleRule": "generateSbom = true",
      "helpMarkDown": "SBOM output format (generated by QScanner)",
      "groupName": "sbom"
    },
    {
      "name": "scanTimeout",
      "type": "string",
      "label": "Scan Timeout (seconds)",
      "required": false,
      "defaultValue": "300",
      "helpMarkDown": "Maximum time for scan execution",
      "groupName": "advanced"
    },
    {
      "name": "continueOnError",
      "type": "boolean",
      "label": "Continue on Error",
      "required": false,
      "defaultValue": "false",
      "helpMarkDown": "Continue pipeline even if scan fails thresholds or encounters errors",
      "groupName": "advanced"
    },
    {
      "name": "publishResults",
      "type": "boolean",
      "label": "Publish SARIF Results",
      "required": false,
      "defaultValue": "true",
      "helpMarkDown": "Publish SARIF results to Azure DevOps for code scanning alerts",
      "groupName": "advanced"
    }
  ],
  "outputVariables": [
    {
      "name": "vulnerabilityCount",
      "description": "Total number of vulnerabilities found"
    },
    {
      "name": "criticalCount",
      "description": "Number of critical vulnerabilities"
    },
    {
      "name": "highCount",
      "description": "Number of high severity vulnerabilities"
    },
    {
      "name": "mediumCount",
      "description": "Number of medium severity vulnerabilities"
    },
    {
      "name": "lowCount",
      "description": "Number of low severity vulnerabilities"
    },
    {
      "name": "policyResult",
      "description": "Policy evaluation result (ALLOW, DENY, AUDIT, NONE)"
    },
    {
      "name": "scanPassed",
      "description": "Whether the scan passed (true/false)"
    },
    {
      "name": "reportPath",
      "description": "Path to the SARIF report file"
    },
    {
      "name": "sbomPath",
      "description": "Path to generated SBOM file(s)"
    }
  ],
  "execution": {
    "Node20_1": {
      "target": "dist/tasks/QualysSCAScan/index.js"
    }
  },
  "restrictions": {
    "commands": {
      "mode": "restricted"
    },
    "settableVariables": {
      "allowed": [
        "vulnerabilityCount",
        "criticalCount",
        "highCount",
        "mediumCount",
        "lowCount",
        "policyResult",
        "scanPassed",
        "reportPath",
        "sbomPath"
      ]
    }
  }
}
